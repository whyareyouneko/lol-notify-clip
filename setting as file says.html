import React, { useEffect, useMemo, useState } from "react";

const roles = ["Top", "Jungle", "Mid", "ADC", "Support"] as const;
const notifStyles = [
  { id: "toast", label: "Toast Notifications" },
  { id: "overlay", label: "In‚ÄëGame Overlay" },
] as const;

type Role = typeof roles[number];
type NotifStyle = typeof notifStyles[number]["id"];

type Settings = {
  role: Role;
  modules: {
    deathTracking: boolean;
    xpTracking: boolean;
    macroCoaching: boolean;
    visionControl: boolean;
  };
  notifications: {
    style: NotifStyle;
  };
  recorder: {
    hotkey: string;
    defaultClipLength: number;
    saveFolder: string;
  };
};

const DEFAULTS: Settings = {
  role: "Mid",
  modules: {
    deathTracking: true,
    xpTracking: true,
    macroCoaching: true,
    visionControl: true,
  },
  notifications: {
    style: "toast",
  },
  recorder: {
    hotkey: "F9",
    defaultClipLength: 30,
    saveFolder: "C:/Users/Games/LoL Clips",
  },
};

function loadSettings(): Settings {
  try {
    const raw = localStorage.getItem("settings");
    if (!raw) return DEFAULTS;
    const parsed = JSON.parse(raw);
    return { ...DEFAULTS, ...parsed, modules: { ...DEFAULTS.modules, ...(parsed.modules||{}) }, notifications: { ...DEFAULTS.notifications, ...(parsed.notifications||{}) }, recorder: { ...DEFAULTS.recorder, ...(parsed.recorder||{}) } };
  } catch {
    return DEFAULTS;
  }
}

function saveSettings(s: Settings) {
  localStorage.setItem("settings", JSON.stringify(s));
}

const SectionCard: React.FC<{ title: string; right?: React.ReactNode }>
= ({ title, right, children }) => (
  <div className="rounded-2xl border border-[#2c2f44] bg-[rgba(12,19,41,.8)]/90 shadow-[0_18px_60px_rgba(0,0,0,.35)] backdrop-blur p-4 md:p-5">
    <div className="flex items-center justify-between mb-3">
      <h3 className="text-sm font-extrabold text-[#e7e4d8] tracking-wide">{title}</h3>
      {right}
    </div>
    {children}
  </div>
);

const Toggle: React.FC<{ checked: boolean; onChange: (v: boolean) => void; label: string; desc?: string }>
= ({ checked, onChange, label, desc }) => (
  <label className="flex items-start gap-3 py-3">
    <button type="button" aria-pressed={checked} onClick={() => onChange(!checked)} className={`relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border border-white/15 transition ${checked ? "bg-emerald-500/70" : "bg-white/10"}`}>
      <span className={`absolute top-1/2 -translate-y-1/2 left-1 transition-transform h-4 w-4 rounded-full bg-white/90 ${checked ? "translate-x-5" : "translate-x-0"}`}></span>
    </button>
    <span className="flex flex-col">
      <span className="font-semibold text-[#e7e4d8]">{label}</span>
      {desc && <span className="text-xs text-[#a7a39a]">{desc}</span>}
    </span>
  </label>
);

const Pill: React.FC<{ children: React.ReactNode }>=({children})=> (
  <span className="ml-2 rounded-lg border border-[#a06bff]/30 bg-[#a06bff]/10 px-2 py-0.5 text-xs text-[#a06bff]">{children}</span>
);

export default function SettingsTab(){
  const [settings, setSettings] = useState<Settings>(() => loadSettings());
  const [saving, setSaving] = useState(false);
  const user = useMemo(()=>{
    try { return JSON.parse(localStorage.getItem("user")||"null"); } catch { return null; }
  }, []);

  useEffect(()=>{ saveSettings(settings); }, [settings]);

  function reset(){ setSettings(DEFAULTS); }
  function save(){ setSaving(true); setTimeout(()=> setSaving(false), 600); saveSettings(settings); }

  return (
    <div className="min-h-screen bg-[radial-gradient(1200px_600px_at_75%_0%,rgba(28,56,124,.45),transparent_60%),radial-gradient(1000px_500px_at_15%_100%,rgba(22,115,189,.35),transparent_60%),linear-gradient(180deg,#0e1835,#070b1a)] text-[#e7e4d8] p-4 md:p-6">
      <div className="mx-auto max-w-5xl flex items-center justify-between rounded-2xl border border-[#9c7b41] bg-[rgba(18,24,46,.92)] shadow-[0_20px_60px_rgba(0,0,0,.4)] px-4 py-3">
        <div className="flex items-center gap-3">
          <div className="grid place-items-center w-8 h-8 rounded-lg bg-gradient-to-br from-[rgba(60,75,140,.9)] to-[rgba(120,82,200,.9)]">
            <svg viewBox="0 0 24 24" className="w-4 h-4" fill="none"><path d="M12 2l7 3v5c0 5.25-3.25 9.94-7 11-3.75-1.06-7-5.75-7-11V5l7-3z" stroke="#F9FAFB" strokeWidth="1.5"/><path d="M9.5 11.25l2 2 3.5-3.5" stroke="#F9FAFB" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"/></svg>
          </div>
          <div>
            <div className="font-extrabold">Settings</div>
            <div className="text-xs text-[#a7a39a]">@{user?.username ?? "guest"}</div>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={reset} className="rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-sm font-semibold">Reset to Defaults</button>
          <button onClick={save} className="rounded-xl bg-gradient-to-r from-[#6bb1ff] to-[#a06bff] px-3 py-2 text-sm font-extrabold shadow-[0_8px_24px_rgba(104,130,255,.35)]">{saving?"Saving‚Ä¶":"Save Changes"}</button>
        </div>
      </div>

      <div className="mx-auto max-w-5xl grid grid-cols-1 gap-5 mt-5">

        <SectionCard title="Role Selection" right={<Pill>Choose Your Role</Pill>}>
          <div className="grid gap-2">
            <label className="text-xs text-[#a7a39a]">Your Role</label>
            <div className="relative w-full md:w-80">
              <select
                value={settings.role}
                onChange={(e)=> setSettings(s=> ({...s, role: e.target.value as Role}))}
                className="w-full appearance-none rounded-xl border border-white/15 bg-[#0b1025] text-[#e7e4d8] px-3 py-2 pr-8 font-semibold"
              >
                {roles.map(r=> <option key={r} value={r} className="bg-[#0b1025] text-[#e7e4d8]">{r}</option>)}
              </select>
              <span className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-white/70">‚ñæ</span>
            </div>
          </div>
        </SectionCard>

        <SectionCard title="Coaching Modules">
          <Toggle checked={settings.modules.deathTracking} onChange={(v)=> setSettings(s=> ({...s, modules:{...s.modules, deathTracking:v}}))} label="Death Tracking" desc="Monitor deaths and suggest improvements" />
          <Toggle checked={settings.modules.xpTracking} onChange={(v)=> setSettings(s=> ({...s, modules:{...s.modules, xpTracking:v}}))} label="XP Tracking" desc="Track experience gains and lane advantages" />
          <Toggle checked={settings.modules.macroCoaching} onChange={(v)=> setSettings(s=> ({...s, modules:{...s.modules, macroCoaching:v}}))} label="Macro Coaching" desc="Objective timers and map awareness" />
          <Toggle checked={settings.modules.visionControl} onChange={(v)=> setSettings(s=> ({...s, modules:{...s.modules, visionControl:v}}))} label="Vision Control" desc="Ward placement and vision score" />
        </SectionCard>

        <SectionCard title="Notification Settings">
          <div className="grid gap-2 mb-3">
            <label className="text-xs text-[#a7a39a]">Notification Style</label>
            <div className="relative w-full md:w-80">
              <select
                value={settings.notifications.style}
                onChange={(e)=> setSettings(s=> ({...s, notifications:{...s.notifications, style: e.target.value as NotifStyle}}))}
                className="w-full appearance-none rounded-xl border border-white/15 bg-[#0b1025] text-[#e7e4d8] px-3 py-2 pr-8 font-semibold"
              >
                {notifStyles.map(n=> <option key={n.id} value={n.id} className="bg-[#0b1025] text-[#e7e4d8]">{n.label}</option>)}
              </select>
              <span className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-white/70">‚ñæ</span>
            </div>
            <p className="text-xs text-[#a7a39a]">Choose how you want to receive coaching tips during gameplay.</p>
          </div>

          <div className="relative h-40 overflow-hidden rounded-xl border border-white/10 bg-[url('https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1200&auto=format&fit=crop')] bg-cover">
            {settings.notifications.style === "toast" ? (
              <div className="absolute right-3 top-3 w-80 animate-[fadeIn_.3s_ease]">
                <div className="rounded-xl border border-white/20 bg-black/60 p-3 shadow-xl">
                  <div className="text-sm font-bold">Dragon spawning in 30s</div>
                  <div className="text-xs text-white/80">Prepare objective control and push mid.</div>
                </div>
              </div>
            ) : (
              <div className="absolute inset-0 grid place-items-center bg-black/35">
                <div className="rounded-xl border border-[#c8aa6e] bg-black/50 px-4 py-3 text-center shadow-[0_0_0_3px_rgba(200,170,110,.18)_inset]">
                  <div className="text-sm font-extrabold tracking-wide">IN‚ÄëGAME OVERLAY</div>
                  <div className="text-xs text-white/80">Ward placed! Vision +45%</div>
                </div>
              </div>
            )}
          </div>
        </SectionCard>

        <SectionCard title="Recording Configuration">
          <div className="grid gap-3 md:grid-cols-2">
            <div>
              <label className="text-xs text-[#a7a39a]">Record Hotkey</label>
              <input
                value={settings.recorder.hotkey}
                onChange={(e)=> setSettings(s=> ({...s, recorder:{...s.recorder, hotkey: e.target.value}}))}
                className="mt-1 w-full rounded-xl border border-white/15 bg-[#0b1025] text-[#e7e4d8] px-3 py-2 font-semibold"
              />
            </div>
            <div>
              <label className="text-xs text-[#a7a39a]">Default Clip Length <span className="text-[#e7e4d8]">{settings.recorder.defaultClipLength}s</span></label>
              <input
                type="range"
                min={10}
                max={90}
                step={5}
                value={settings.recorder.defaultClipLength}
                onChange={(e)=> setSettings(s=> ({...s, recorder:{...s.recorder, defaultClipLength: Number(e.target.value)}}))}
                className="mt-3 w-full"
              />
              <div className="flex justify-between text-xs text-[#a7a39a]"><span>10s</span><span>90s</span></div>
            </div>
            <div className="md:col-span-2">
              <label className="text-xs text-[#a7a39a]">Save Folder</label>
              <div className="mt-1 flex gap-2">
                <input
                  value={settings.recorder.saveFolder}
                  onChange={(e)=> setSettings(s=> ({...s, recorder:{...s.recorder, saveFolder: e.target.value}}))}
                  className="flex-1 rounded-xl border border-white/15 bg-[#0b1025] text-[#e7e4d8] px-3 py-2 font-semibold"
                />
                <button className="rounded-xl bg-gradient-to-r from-[#6bb1ff] to-[#a06bff] px-3 py-2 font-bold">üìÅ</button>
              </div>
            </div>
          </div>
        </SectionCard>
      </div>
      <style>{`@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}`}</style>
    </div>
  );
}
